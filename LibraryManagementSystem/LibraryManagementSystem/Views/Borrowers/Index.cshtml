@model IEnumerable<LibraryManagementSystem.Models.Borrower>

<h2>Borrowers</h2>

<div class="mb-3">
    <button type="button" id="addBorrowerBtn" class="btn btn-success">Add Borrower</button>
    <button id="advancedFilterBtn" class="btn btn-link">Advanced Filter</button>

</div>
<br />

<div id="advancedFilter" style="display: none;">
    <form id="filterForm">
        <div class="form-row">
            <div class="form-group col-md-3">
                <input type="text" name="FirstName" class="form-control" placeholder="First Name" value="@Request.QueryString["FirstName"]">
            </div>
            <div class="form-group col-md-3">
                <input type="text" name="LastName" class="form-control" placeholder="Last Name" value="@Request.QueryString["LastName"]">
            </div>
            <div class="form-group col-md-3">
                <input type="text" name="Phone" class="form-control" placeholder="Phone" value="@Request.QueryString["Phone"]">
            </div>
            <div class="form-group col-md-3">
                <input type="text" name="Email" class="form-control" placeholder="Email" value="@Request.QueryString["Email"]">
            </div>
            <div class="form-group col-md-3">
                <input type="text" name="IDNumber" class="form-control" placeholder="ID Number" value="@Request.QueryString["IDNumber"]">
            </div>
            <div class="form-group col-md-3">
                <input type="checkbox" name="IsActive" class="form-check-input" @(Request.QueryString["IsActive"] == "true" ? "checked" : "")>
                <label class="form-check-label">Active</label>
            </div>
            <button type="button" id="applyFilterBtn" class="btn btn-primary">Filter</button>
            <button type="button" id="resetFilterBtn" class="btn btn-secondary ml-2">Reset</button>
        </div>
        <br />
    </form>
</div>

<table id="borrowersTable" class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>ID Number</th>
            <th>Age</th>
            <th>Status</th>
            <th style="width:100px">Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var borrower in Model)
        {
        <tr data-id="@borrower.BorrowerID">
            <td>@borrower.FirstName</td>
            <td>@borrower.LastName</td>
            <td>@borrower.Phone</td>
            <td>@borrower.Email</td>
            <td>@borrower.IDNumber</td>
            <td>@borrower.Age</td>
            <td>@(borrower.IsActive ? "Active" : "Inactive")</td>
            <td >
                <button class="btn btn-warning edit-btn"  title="Edit">
                    <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-danger delete-btn"  title="Delete">
                    <i class="fas fa-trash"></i> 
                </button>
            </td>
        </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="addBorrowerModal" tabindex="-1" role="dialog" aria-labelledby="addBorrowerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBorrowerModalLabel">Add Borrower</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addBorrowerForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="FirstName">First Name</label>
                        <input type="text" class="form-control" id="FirstName" name="FirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="LastName">Last Name</label>
                        <input type="text" class="form-control" id="LastName" name="LastName" required>
                    </div>
                    <div class="form-group">
                        <label for="Phone">Phone</label>
                        <input type="text" class="form-control" id="Phone" name="Phone" required>
                    </div>
                    <div class="form-group">
                        <label for="Email">Email</label>
                        <input type="email" class="form-control" id="Email" name="Email" required>
                    </div>
                    <div class="form-group">
                        <label for="IDNumber">ID Number</label>
                        <input type="text" class="form-control" id="IDNumber" name="IDNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="Age">Age</label>
                        <input type="number" class="form-control" id="Age" name="Age" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="IsActive" name="IsActive">
                        <label class="form-check-label" for="IsActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Borrower</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editBorrowerModal" tabindex="-1" role="dialog" aria-labelledby="editBorrowerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBorrowerModalLabel">Edit Borrower</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editBorrowerForm">
                <div class="modal-body">
                    <input type="hidden" id="EditBorrowerID" name="BorrowerID" />
                    <div class="form-group">
                        <label for="EditFirstName">First Name</label>
                        <input type="text" class="form-control" id="EditFirstName" name="FirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="EditLastName">Last Name</label>
                        <input type="text" class="form-control" id="EditLastName" name="LastName" required>
                    </div>
                    <div class="form-group">
                        <label for="EditPhone">Phone</label>
                        <input type="text" class="form-control" id="EditPhone" name="Phone" required>
                    </div>
                    <div class="form-group">
                        <label for="EditEmail">Email</label>
                        <input type="email" class="form-control" id="EditEmail" name="Email" required>
                    </div>
                    <div class="form-group">
                        <label for="EditIDNumber">ID Number</label>
                        <input type="text" class="form-control" id="EditIDNumber" name="IDNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="EditAge">Age</label>
                        <input type="number" class="form-control" id="EditAge" name="Age" required>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="EditIsActive" name="IsActive">
                        <label class="form-check-label" for="EditIsActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    $(document).ready(function() {
        $('#addBorrowerBtn').click(function() {
            $('#addBorrowerModal').modal('show');
        });

        $('#addBorrowerForm').submit(function(event) {
            event.preventDefault();
            $.ajax({
                url: '@Url.Action("Create", "Borrowers")',
                type: 'POST',
                data: $(this).serialize(),
                success: function(result) {
                        location.reload();                   
                },
                error: function() {
                    alert("An error occurred.");
                }
            });
        });

        $('.edit-btn').click(function() {
            var row = $(this).closest('tr');
            var id = row.data('id');
            var firstName = row.find('td').eq(0).text();
            var lastName = row.find('td').eq(1).text();
            var phone = row.find('td').eq(2).text();
            var email = row.find('td').eq(3).text();
            var idNumber = row.find('td').eq(4).text();
            var age = row.find('td').eq(5).text();
            var isActive = row.find('td').eq(6).text() === 'Active';

            $('#EditBorrowerID').val(id);
            $('#EditFirstName').val(firstName);
            $('#EditLastName').val(lastName);
            $('#EditPhone').val(phone);
            $('#EditEmail').val(email);
            $('#EditIDNumber').val(idNumber);
            $('#EditAge').val(age);
            $('#EditIsActive').prop('checked', isActive);

            $('#editBorrowerModal').modal('show');
        });

      $('#applyFilterBtn').click(function () {
      var formData = $('#filterForm').serialize();


    $.ajax({
        url: '@Url.Action("Index", "Borrowers")',
        type: 'GET',
        data: formData,
        success: function (data) {
            $('#borrowersTable').html($(data).find('#borrowersTable').html());
        },
        error: function () {
            alert("An error occurred.");
        }
    });
          });

        $('#editBorrowerForm').submit(function(event) {
            event.preventDefault();
            $.ajax({
                url: '@Url.Action("Edit", "Borrowers")',
                type: 'POST',
                data: $(this).serialize(),
                success: function (result) {
                    $('#editBorrowerModal').modal('hide');

                        location.reload();

                },
                error: function() {
                    alert("An error occurred.");
                }
            });
        });

        $('#advancedFilterBtn').click(function () {
            $('#advancedFilter').toggle();
        });

     $('#resetFilterBtn').click(function () {
         $('#filterForm')[0].reset();

        $.ajax({
            url: '@Url.Action("Index", "Borrowers")',
            type: 'GET',
            success: function (data) {
                $('#borrowersTable').html($(data).find('#borrowersTable').html());
            },
            error: function () {
                alert("An error occurred.");
            }
        });

});
       $('.delete-btn').click(function () {
    var row = $(this).closest('tr');
    var id = row.data('id');

    if (confirm("Are you sure you want to delete this borrower?")) {
        $.ajax({
            url: '@Url.Action("Delete", "Borrowers")',
            type: 'POST',
            data: { id: id },
            success: function(result) {
                if (result.success) {
                    alert(result.message);  // הצגת הודעה על הצלחה
                    row.remove();
                } else {
                    alert(result.message);  // הצגת הודעת שגיאה אם יש הלוואות פעילות
                }
            },
            error: function() {
                alert("An error occurred while trying to delete the borrower.");
            }
        });
    }
});

    });
</script>

